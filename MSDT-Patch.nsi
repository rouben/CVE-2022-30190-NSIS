; Microsoft Diagnostic Toolkit (MSDT) CVE-2022-30190 (Follina) mitigation patch
; The purpose of this simple NSIS program is to apply and roll back the suggested
; mitigation as per:
; https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-30190

; HM NIS Edit Wizard helper defines
!define PRODUCT_NAME "MSDTPatcher"
!define PRODUCT_VERSION "1.0"

SetCompressor bzip2

Name "${PRODUCT_NAME} ${PRODUCT_VERSION}"
OutFile "${PRODUCT_NAME}-${PRODUCT_VERSION}.exe"
;LoadLanguageFile "${NSISDIR}\Contrib\Language files\English.nlf"
; InstallDir "$PROGRAMFILES\MSDT Patcher"
;Icon "${NSISDIR}\Contrib\Graphics\Icons\modern-install.ico"

Section "MainSection" SEC01

  EnumRegKey $1 HKCR "ms-msdt" 0 ; Check if HKCR\ms-msdt exists
  StrCmp $1 "" patched  ; If the HKCR\ms-msdt key doesn't exist, patch was applied
  MessageBox MB_YESNO|MB_ICONQUESTION "It looks like this system may be vulnerable to the MS $\r$\n\
                                  Diagnostic Toolkit (MSDT) vulnerability.$\r$\n$\r$\n\
                                  Would you like to apply the mitigation patch?" \
                                  IDYES applypatch \
                                  IDNO abort

applypatch:
  DeleteRegKey HKCR "ms-msdt"
  EnumRegKey $1 HKCR "ms-msdt" 0 ; Check if HKCR\ms-msdt exists
  StrCmp $1 "" patchsuccess patchfail

patchsuccess:
  MessageBox MB_OK|MB_ICONINFORMATION "Mitigation applied successfully. To revert the change $\r$\n\
                                   run this program again."
  Quit
                                   
patchfail:
  MessageBox MB_OK|MB_ICONEXCLAMATION "Failed to apply mitigation patch! Please try running this $\r$\n\
                                   program again with administrative privileges (Run As Administrator)."
  Abort "Failed to apply mitigation patch. Try re-running as Administrator."
  
patched:
  MessageBox MB_YESNO|MB_ICONQUESTION "It looks like the mitigation is in place already. You can $\r$\n\
                                   undo the mitigation patch if you have already installed a $\r$\n\
                                   fix for it from Microsoft. Otherwise, please click 'No' to exit.\
                                   $\r$\n$\r$\nDo you wish to revert (undo the mitigation patch)?" \
                                   IDNO abort \
                                   IDYES undopatch
undopatch:
  WriteRegStr HKCR "ms-msdt" "" "URL:ms-msdt"
  WriteRegDWORD HKCR "ms-msdt" "EditFlags" 0x200000
  WriteRegStr HKCR "ms-msdt" "URL Protocol" ""
  WriteRegExpandStr HKCR "ms-msdt\shell\open\command" "" "$\"%SystemRoot%\system32\msdt.exe$\" %1"
  EnumRegKey $1 HKCR "ms-msdt" 0 ; Check if HKCR\ms-msdt exists
  StrCmp $1 "" undofail undosuccess

undofail:
  MessageBox MB_OK|MB_ICONEXCLAMATION "Failed to undo mitigation patch! Please try running this $\r$\n\
                                   program again with administrative privileges (Run As Administrator)."
  Abort "Failed to apply mitigation patch. Try re-running as Administrator."
  
undosuccess:
  MessageBox MB_OK|MB_ICONINFORMATION "Mitigation patch rolled back successfully. If you did not $\r$\n\
                                   yet install the fix from Microsoft, please run this program $\r$\n\
                                   again to re-apply the patch!"
  Quit

abort:
  MessageBox MB_OK|MB_ICONINFORMATION "No changes were made as you requested. This program will now exit."
  Abort "User cancelled."
SectionEnd